name: Deploy to Production

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          [ -n "${{ secrets.SSH_HOST }}" ] || { echo "SSH_HOST empty"; exit 1; }
          [ -n "${{ secrets.SSH_USER }}" ] || { echo "SSH_USER empty"; exit 1; }
          [ -n "${{ secrets.SSH_KEY }}" ]  || { echo "SSH_KEY empty"; exit 1; }
          [ -n "${{ secrets.SERVER_PATH }}" ] || { echo "SERVER_PATH empty"; exit 1; }

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 3m
          command_timeout: 45m
          script: |
            set -e
            cd ${{ secrets.SERVER_PATH }}
            git fetch --all
            git reset --hard origin/prod
            [ -f .env.production ] || { echo "❌ .env.production not found"; exit 1; }
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            docker compose -f docker-compose.prod.yml up -d --build
            sleep 10
            curl -fsS http://localhost:3000/api/health || {
              echo "❌ Health check failed"
              docker compose -f docker-compose.prod.yml logs --tail=200
              exit 1
            }
            echo "✅ Done: https://heartofzha.ru"

      - name: Notify on failure
        if: failure()
        run: echo "❌ Deployment failed. Check logs."